# Diario dello sviluppatore, data 17 ottobre 2025

* [index](../index.md)

* [TDL](../TDL.md)
* [project](https://github.com/users/mrai64/projects/1)
* [◀️ ieri](./2025-10-16_IT.md)
* [log](/storage/logs/laravel.log)

## Ancora reformat

Passata la notte, riprendo ad allineare il "facile" reformat delle tabelle
Federation e FederationSection. Quando una cosa va fatta bene...
Altra novità da imparare, si può dire a laravel che la primaryKey
non è il solito bigint ed è fatta da due colonne e non va incrementata
però alla fine ne vale la pena?
prima c'era un id e un index unique(),
e quello che da qualche parte consigliano è di tornare a id (a perdere)

### Alla fine son tornato indietro

La scelta di fare la chiave pk federation_id code sta creando
un po' di problemi e uno dei consigli è quello di lasciar stare
e usare il caro vecchio id bigint mettendo un indice
unique() per mantenere la stessa funzione della pk che voglio io.

Aggiornamento: la pk su mysql non tiene conto dei campi softdeleted,
al duo va aggiunto anche il campo deleted_at. Così se inserisco,
poi cancello, poi inserisco con lo stesso code di prima funziona.

### Nuovi Users ma niente user_Contacts

Situazione poco chiara: quando si viene a creare un
nuovo record n tabella users deve essere creato anche un nuovo record
in user_contacts che abbia almeno una manciata di dati già presenti.

Mysql fornisce il trigger:

```sql
CREATE TRIGGER user_contacts_trigger
  AFTER INSERT ON users
  FOR EACH ROW 
  INSERT INTO user_contacts ( user_id, first_name, last_name, email    ) 
                     VALUES ( NEW.id,  NEW.name,   NEW.name,  NEW.email);

```

Funziona, a patto di aggiungere anche un country_id che in cp_user_contacts non
ha un valore predefinito, e di aggiungere anche il prefisso alla tabella perché
viene "preso com'è"

```sql
CREATE TRIGGER `user_contacts_ins_trigger` 
AFTER INSERT ON `pcp_users` 
FOR EACH ROW INSERT INTO user_contacts 
( user_id, first_name, last_name, email    , country_id ) VALUES 
( NEW.id,  NEW.name,   NEW.name,  NEW.email, '')
```

Questo mi garantisce che se ne occupa mysql, ma resta un ma:
la password? Va indicato al nuovo utente che come primo collegamento,
non avendo inserito lei/lui la propria password personale deve cliccare
al primo login su "forgot password" e passare a controllare
la propria posta elettronica. Riceverà un link che gli consente
di inserire la password che vuole e che non è rintracciabile
da noi, nemmeno vogliamo saperla.

Federations e federation_sections condividono l'uuid federations.id federation_sections.federation_id,  
allo stesso modo in cui  
users e user_contacts condividono users.id e user_contacts.user_id.
Per federation_sections ho dovuto creare l'indice unique e aggiungere il campo deleted_at,
mo faccio lo stesso per users con email che è unique fintanto che non si cancella un record...


### SentiMaaa... Database seeder come va fatto?

Deve richiamare un elenco di Xseeder::class,
naturalmente in ordine di dipendenza.
Prima quelle indipendenti poi quelle dipenttenti.
Un seeder per un intero concorso?
Si può fare, come sarebbe interessante predisporre
un json_encode che diventa un file yaml
