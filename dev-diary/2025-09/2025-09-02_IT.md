# Diario dello sviluppatore, data 2 settembre 2025

Nav: [index](../index.md) : [TDL](../TDL.md) : [log](../../storage/logs/laravel.log)

## Upload passport photo

La pagina modify funziona per tutti i campi escluso quello dell'immagine, oggi modifiche al controller e al blade
per aggiungere un upload file

*Per questioni di sicurezza non sono ammessi svg*?, probabilmente
svg essendo testo interpretato apre il fianco a trucchi che
non conosco ancora.

1. ‚úÖ Dire a laravel che deve gestire uno spazio disco
1. ‚úÖ Modificare il form per aggiungere il caricamento immagine
1. ‚úÖ Modificare il controller per validare l'immagine
1. ‚úÖ Modificare il controller per posizionare l'immagine nel disco
1. ‚úÖ Modificare il controller per visualizzare l'immagine al fianco del campo

ref. [Laravel File Storage](https://laravel.com/docs/12.x/filesystem)

* Si possono definire n dischi
  Questo comporta che per esempio posso tenere separati i work
  dai passport_photo, o anche tenerli insieme perch√©
  ci sar√† a far da chiave il valore dell'uuid assegnato
* esiste un riferimento `Storage::disk('local')`,
  e un disco public che va collegato, se sta su un server
  locale o se sta in un server remoto
* prima di usare, configurare. Si possono configurare abbonamenti al sistema amazon S3 ([*Amazon Simple Storage Service*](https://aws.amazon.com/it/s3/) adottato anche da altri come Aruba), o con il protocollo FTP *(meglio sftp, se si pu√≤)* o con il protocollo SFTP (richiede certificati di accesso).
* si possono configurare dei filesystem che in automatico aggiungono un prefisso, e quindi sono dedicati *Scoped* e si possono definire anche filesystem a sola lettura, tipo cd-rom üìÄ.

TODO: Aggiungere il titolo Mr. Mrs. other gender

### Dire a Laravel che deve mettere via file

In `storage/app/public` che deve essere accessibile da un link simbolico in `public/storage`

```php
$ php artisan storage:link

  INFO  The [public/storage] link has been connected to [storage/app/public].  
```

Creazione del link in `config/filesystem.php` per ora lascio com'√®

```php
    'links' => [
        public_path('storage') => storage_path('app/public'),
    ],
```

Adesso si va a cambiare `update()`, mmm no troppo diverso da quello che devo fare.
in questo tutorial non c'√® livewire ma React, usa il `method="POST"` e nel controller
che riceve i dati c'√® input `Request $request`, insomma un'altra parrocchia.

[Altro tutorial](https://www.youtube.com/watch?v=j2W06d-aVv0&list=PL6tf8fRbavl0Trc4Y9uxTXfcdATsv0PBs&index=2)
Importante distinguere il dato in tabella NON √à l'immagine.
Quindi nel modulo il campo dell'immagine dev'essere diverso dalla colonna passport_photo.
*Nota: non usare il metodo upload()*, **upload** √® riservato a livewire.

Ok, ottimo. **Nessun errore e ...fatto niente**. Che `$this` arriva dal form? $passport_photo_image vuoto

Pensato di girare tutto come un calzino, sostanzialmente s√¨, funziona ma serve
salvare in passport_photo un path e nome file, e se nel nome file ci sono spazi?
(senza *se*, prima o poi ci sono, o anche peggio)

urlencode() urldecode()? str_ireplace()? Se lo faccio in store devo farlo in pick.
Il campo della tabella si aggiorna, ma il file no.

E invece...  
funzione: storeAs( path, name) memorizza nella /private.  
funzione: storePubliclyAs( path, name) memorizza nella /public.  

La luce!

`<img src="{{ asset('assets/upload/imgdogs') . '/' . $row->dogpic }}" alt="" class="image">`

```php
$ php artisan livewire:publish --config

   INFO  Publishing [livewire:config] assets.  

  Copying file [vendor/livewire/livewire/config/livewire.php] to [config/livewire.php] ........................................................ DONE
```

Alla fine la combo giusta sembra essere  
`<img src="{{ asset('storage/photos') . '/' . $passport_photo }}" alt="" style="float: left;" class="block w-48 me-3">`.  
Mi mantiene la img a sinistra del campo (il div viene seguito da un br clear:both e il div seguente ha un margin top 4),
allo stesso tempo l'immagine √® ben visibile ma no fa l'effetto *patente sul monitor di NCIS*.

Risolto **commit*

TODO Il cambio della email si deve fare da dove? √à chiave di ingresso, con la password
e a quella email si deve fare riferimento 

Prossimo step: cambiare la cartella di salvataggio delle opere e delle passport photo,
da . . . . . . ./photos/(country_id)_(last_name)_(first_name)/* e quando sono troppi  
pu√≤ diventare. ./photos/(country_id)/(last_name)_(first_name)/* e quando sono troppi  
pu√≤ diventare. ./photos/(country_id)/(last_name)/(first_name)/* e quando ...  
pu√≤ diventare. ./photos/(country_id)/(spezzone di 3 da last_name)/last_name/first_name  
ma anche . . . ./photos/(country_id)/(spezzone di user_id)/(user_id)/*  

Il caricamento delle immagini dev'essere non bloccante, per cui si useranno:

- data-src con l'url della foto
- src con parametro lazy 
- srcset con le versioni dell'immagine a diverse misure.

### User/Works

E qui cominciamo ad andare su, il modulo di caricamento delle opere deve si caricare
ma anche assegnare un work_id uuid, lo faccio diventare primary key. Il campo user_id
sar√† owner dell'immagine, e avr√† diritto di vedere tutti i suoi lavori.
La tabella dei lavori partecipanti avr√† un elenco di work_id, abbinato a un contest_id anche quello uuid.
I giurati avranno accesso a tutti i work_id che fanno parte del contest+section_id a loro assegnato.

**E perch√© non Works**? E sia.

```php
$ php artisan make:model Work -mfs

   INFO  Model [app/Models/Work.php] created successfully.  

   INFO  Factory [database/factories/WorkFactory.php] created successfully.  

   INFO  Migration [database/migrations/2025_09_02_211727_create_works_table.php] created successfully.  

   INFO  Seeder [database/seeders/WorkSeeder.php] created successfully.  
```
