# 09/02/2026

[⏪ ieri](./2026-02-08_IT.md) | [index](../index.md) | [domani ⏩](./2026-02-10_IT.md)  
[Docs](/resources/docs/1.0/overview.md)

## Ambiente di test

Posto che una "facilitazione" deve essere tale, adesso che voglio
mettere in piedi il primo test con database serve
*un gemello di test* del database. e va mantenuto allineato.  
Vuoi che non ci sia un package che lo fa?

In effetti il package non c'è, è in dote a Laravel.

Tutto sta a creare il database e dare allo stesso
utente gli stessi poteri di fare e disfare
In realtà servirebbero due utenti:  
. uno che aggiunge e toglie record,  
. uno che può anche aggiungere e togliere tabelle.indici, fare migration.

### Creare database gemello

```sh
CREATE DATABASE IF NOT EXISTS pcpdb_test
  CHARACTER SET "utf8mb4";
USE pcpdb_test;
CREATE USER '...'@'127.0.0.1' IDENTIFIED BY '...';
GRANT ALL ON pcpdb_test.* TO '...'@'127.0.0.1';
```

User e password sono quelli in `.env.testing`

```sh
$ mysqldump --socket /tmp/mysql_3306.sock -u root --port=3306 -p --no-data pcpdb > ~/Downloads/yapcp.sql
Enter password: 
```

Importato in Sequel Ace, scelto Esegui tutte le query al posto di esegui corrente / precedente e va. fatto la copia. **Database definito ma vuoto**, non ci sono nemmeno le countries e le timezone.

### Test

Adesso vediamo se cambia qualcosa

```sh
$ php artisan test tests/Feature/Auth/RegistrationTest.php -v
giuseppa.piras@athesis77.it

   FAIL  Tests\Feature\Auth\RegistrationTest
  ✓ it registration page reachable                                                                                           0.18s  
  ⨯ it new user registration                                                                                                 0.35s  
  ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────  
   FAILED  Tests\Feature\Auth\RegistrationTest > it new user registration                                          QueryException   
  SQLSTATE[HY000]: General error: 1 no such table: users (Connection: sqlite, Database: :memory:, SQL: select count(*) as aggregate from "users" where "email" = giuseppa.piras@athesis77.it)
```

Oh com'è? ancora sqlite? Confessionale gemini

La modifica di phpunit.xaml no prevede campi in più

```xml
        <env name="DB_CONNECTION" value="mysql" was="sqlite"/>
        <env name="DB_DATABASE" value="pcpdb_test" was=":memory:"/>
```

```sh
$ php artisan test tests/Feature/Auth/RegistrationTest.php -v

   WARN  Test results may not be as expected because the XML configuration file did not pass validation:

  Line 25:
  - Element 'env', attribute 'was': The attribute 'was' is not allowed.

  Line 26:
  - Element 'env', attribute 'was': The attribute 'was' is not allowed.


   FAIL  Tests\Feature\Auth\RegistrationTest
  ⨯ it registration page reachable
  ⨯ it new user registration
  ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────  
   FAILED  Tests\Feature\Auth\RegistrationTest > it registration page reachable                            ProcessFailedException   
  The command "mysql  --user="${:LARAVEL_LOAD_USER}" --password="${:LARAVEL_LOAD_PASSWORD}" --host="${:LARAVEL_LOAD_HOST}" --port="${:LARAVEL_LOAD_PORT}" --database="${:LARAVEL_LOAD_DATABASE}" < "${:LARAVEL_LOAD_PATH}"" failed.
...
```

Dopo *una lunga discussione con gemini* la soluzione sembra sia rigenerare le migration
che gemini mi aveva detto di buttare avendo creato mysql schema.  
Vengono rigenerate in buon ordine e passo a riformarle.

Ricordarsi di aggiornare

Buona la prima anzi bene non benissimo. la generazione delle colonne
si è completamente dimenticata di portarsi dietro la definizione del charset
e della collation, che ho impostato per gli uuid. E per i vari country_id.

Serve fare prima di ricaricare le tabelle

```sh
php artisan migrate:fresh
```

Questo brasa tutto, comprese le view, e poi parte dalle migration per
ricostruire le tabelle. La creazione delle tabelle, la creazione degli indici, la creazione delle relazioni tra tabelle.

La tabella migration tiene "solo" 303 record. Quando faccio refresh
deve essere buona la prima, perché sì.

* Rintracciate e spostate "a mezzanotte" le definizioni delle tabelle
  di sistema caches, session, jobs
* Tabelle region, timezone e countries "dal primo minuto" in poi
* Tabelle che dipendono da nessuno o da countries e timezones "dall'una in poi"
  * users
  * organizations
  * federations
* tabelle che dipendono direttamente dalle tabelle precedenti

Visto che *sicuramente* ci sarà qualcosa da sistemare, ne approfitto per farlo
per esempio voglio che la creazione del record userContacts sia fatta da php
e non "nascosta" da un mysql trigger, anche se più comoda.
Per esempio la classe Work voglio che diventi quello che è: UserWork e quindi anche la tabella.
