# Chiedi a Gemini del 12 febbraio 2026

## Domanda 1

laravel Quando un nuovo user si registra e passa la verifica della email devo predisporre nello script la generazione di un evento UserEmailVerified con parametro che passo una istanza di users. e quindi nel Listener UserContactBuilder ottenere dall'evento i dati di user e verificare che in UserContact non sia già presente un record con la stessa email (con softdelete può essere) e inserirlo, se presente, aggiornare il record (magari azzerando il campo deleted_at).

## Risposta 1

È un ottimo approccio: utilizzare gli eventi di Laravel rende il codice pulito e "disaccoppiato". Invece di sporcare il controller della verifica con logiche di database extra, deleghi tutto a un Listener dedicato.

Ecco come strutturare il tutto seguendo le best practices di Laravel.

### 1. L'Evento: `UserEmailVerified`

Per prima cosa, assicurati che l'evento accetti l'istanza di `User` nel costruttore.

```php
namespace App\Events;

use App\Models\User;
use Illuminate\Foundation\Events\Dispatchable;
use Illuminate\Queue\SerializesModels;

class UserEmailVerified
{
    use Dispatchable, SerializesModels;

    public $user;

    public function __construct(User $user)
    {
        $this->user = $user;
    }
}

```

---

### 2. Il Listener: `UserContactBuilder`

Qui gestiamo la logica di **Upsert** (Update or Insert) tenendo conto dei **Soft Deletes**. Per recuperare record eliminati (con `deleted_at`), dobbiamo usare il metodo `withTrashed()`.

```php
namespace App\Listeners;

use App\Events\UserEmailVerified;
use App\Models\UserContact;

class UserContactBuilder
{
    public function handle(UserEmailVerified $event)
    {
        $user = $event->user;

        // Cerchiamo il contatto includendo quelli "soft-deleted"
        $contact = UserContact::withTrashed()
            ->where('email', $user->email)
            ->first();

        if ($contact) {
            // Se esiste, aggiorniamo e ripristiniamo (se era eliminato)
            $contact->update([
                'name' => $user->name,
                'deleted_at' => null, // Ripristino manuale o $contact->restore()
            ]);
        } else {
            // Se non esiste, lo creiamo da zero
            UserContact::create([
                'user_id' => $user->id,
                'email'   => $user->email,
                'name'    => $user->name,
            ]);
        }
    }
}

```

> **Nota di stile:** Se usi `withTrashed()`, puoi anche chiamare `$contact->restore()` invece di settare manualmente `deleted_at` a null, il che è più "Laravel-friendly".

---

### 3. Registrazione nel `EventServiceProvider`

Non dimenticare di collegare l'evento al listener nel file `app/Providers/EventServiceProvider.php` (o tramite l'autodiscovery se usi Laravel 11).

```php
protected $listen = [
    UserEmailVerified::class => [
        UserContactBuilder::class,
    ],
];

```

---

### 4. Trigger dell'evento

Nel punto in cui la verifica della mail avviene con successo (solitamente nel controller che gestisce `Verified`), scatena l'evento:

```php
use App\Events\UserEmailVerified;

// ... dopo aver marcato l'email come verificata
event(new UserEmailVerified($user));

```

### Un piccolo consiglio "Pro"

Se la tabella `UserContact` ha un indice `unique` sulla colonna `email`, potresti usare il metodo `updateOrCreate`, ma attenzione: `updateOrCreate` di default non vede i record cancellati con SoftDelete. La logica manuale che abbiamo scritto sopra con `withTrashed()` è la più sicura per il tuo caso specifico.

Vuoi che ti aiuti a scrivere anche la **Migration** per la tabella `UserContact` assicurandoci che gli indici siano corretti per i Soft Deletes?
