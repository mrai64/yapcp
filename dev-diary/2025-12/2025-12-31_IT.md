# Diario dello sviluppatore, data 31 dicembre 2025

* [index](../index.md) |
  [project](https://github.com/users/mrai64/projects/1/views/1?filterQuery=is%3Aopen&sortedBy%5Bdirection%5D=asc&sortedBy%5BcolumnId%5D=Title) issue list |
  [To Do List](../TDL.md) svuotato  

* [Route](/routes/web.php)

* [◀️ Diario di ieri](./2025-12-30_IT.md)

* run <http://yapcp.test/>
* User Doc <http://yapcp.test/docs/1.0/> [index](/resources/docs/1.0/index.md)
* [log](/storage/logs/laravel-2025-12-31.log) | ngnix log  `open ~/Library/Application\ Support/Herd/Log`

## Today Do list

* User Contact Modify, la parte per le federazioni

## UserContact Modify / 5 Federation requirements

L'aggiornamento va male, non trova le regole che a mio parere ci sono.
Devo sostituire la valorizzazione dell'array per il modulo dinamico
perché fanno casino le \[ ] nelle elaborazioni laravel, devo quindi avere una collection
che contenga sia le definizioni che gli eventuali valori presenti per utente
e federazione.

```sql
select 
  federation_field_name AS name,
  federation_field_label AS label,
  federation_field_validation_rules AS validation,
  federation_field_default_value AS default_value,
  coalesce(federation_additionals.federation_field_value, federation_additional_field_names.federation_field_default_value) AS value
from federation_additional_field_names
left join federation_additionals
  on federation_additionals.federation_field_name = federation_additional_field_names.federation_field_name
  and federation_additionals.user_contact_user_id = ?
  and federation_additionals.federation_id = ?
where federation_additional_field_names.federation_id = ?
order by federation_field_name asc;
-- with parameters: [user_contact_user_id, federation_id, federation_id]
-- this query retrieves federation additional fields along with their values for a specific user and federation, using COALESCE to handle default values.
```

Mi diventa

```php
use Illuminate\Support\Facades\DB;
use App\Models\FederationAdditionalFieldName; // Sostituisci con il tuo modello reale

$userId = '...';    // Il tuo parametro user_contact_user_id
$federationId = '...'; // Il tuo parametro federation_id

$fieldDefinitions = FederationAdditionalFieldName::select([
    // Alias semplici
    'federation_additional_field_names.federation_field_name AS name',
    'federation_additional_field_names.federation_field_label AS label',
    'federation_additional_field_names.federation_field_validation_rules AS validation',
    'federation_additional_field_names.federation_field_default_value AS default_value',
    
    // Utilizzo di COALESCE per il valore
    DB::raw('COALESCE(federation_additionals.federation_field_value, federation_additional_field_names.federation_field_default_value) AS value')
])
// LEFT JOIN
->leftJoin('federation_additionals', function ($join) use ($userId, $federationId) {
    // ON federation_additionals.federation_field_name = federation_additional_field_names.federation_field_name
    $join->on('federation_additionals.federation_field_name', '=', 'federation_additional_field_names.federation_field_name')
         // AND federation_additionals.user_contact_user_id = ?
         ->where('federation_additionals.user_contact_user_id', '=', $userId)
         // AND federation_additionals.federation_id = ?
         ->where('federation_additionals.federation_id', '=', $federationId);
})
// WHERE federation_additional_field_names.federation_id = ?
->where('federation_additional_field_names.federation_id', $federationId)
// ORDER BY federation_field_name asc
->orderBy('federation_additional_field_names.federation_field_name', 'asc')
->get();
```

E niente, ...mi sto incartando senza riuscire a ragionare
lucidamente. Quindi reset: riparto dal primo suggerimento e
vedo di leggere con estrema attenzione i suggerimenti
di Gemini.

* Pagina senza campi dinamici  
Tutto bene, il giro funziona, per quanti pochi campi e federazioni ci sono
potrei fare un modulo per ogni federazione, poi però... 
* Aggiungere i campi dinamici  
Quindi devo andare a pescare i campi dalla tabella delle definizioni
dei campi in FederationAdditionFieldName  
La prima versione crea un array con i campi da impostare che sono
label, name del campo e value, aggiungendo a parte una ricerca 
per il valore se ci sono già dei record memorizzati per federazione e utente.  
Non funziona la validazione.  
Provo a cambiare creando uan sola query con coalesce
per aver io valore del campo o il valore predefinito, tutto
molto bello ma: non funziona la validazione.  
Provo a passare alla dot notation  
Ma non funziona la validazione
Alla fine pare che il problema sia in Laravel,
ovvero mi aspetto che una collection creata in mount() sia disponibile
anche nelle altre funzioni rules() perché è una variabile globale, ma non è così.  
Sono disponibili tipi semplici, anche array ma non le collection.
* Aggiungere le rules. Ho imparato a mie spese che i dati semplici come $this->federation_id, ma anche qualche array vengono mantenuti in memoria tra una chiamata e l'altra, ma questo non vale sempre, specialmente per le collection. Pertanto quando andava bene alle rules() non arrivavano dati e quindi usciva con un array vuoto = regole non trovate.
