# Diario dello sviluppatore, data 14 dicembre 2025

* [index](../index.md) |
  [To Do List](../TDL.md) da svuotare e migrare in |
  [project](https://github.com/users/mrai64/projects/1) issue list

* [Route](/routes/web.php)

* [◀️ Diario di ieri](./2025-12-13_IT.md)

* run <http://yapcp.test/>
* [log](/storage/logs/laravel-2025-12-14.log) | ngnix log  `open ~/Library/Application\ Support/Herd/Log`

## Pagina Assegnazione premi per concorso

Manca adesso il focus della pagina, l'assegnazione dei premi di circuito
che per forza di cose non possono essere assegnati a un'opera ma vanno
assegnati a partecipanti o a gruppi di partecipanti. Serve quindi
un doppio campo di selezione, uno che abbia in selezione tutti i
partecipanti dotati di almeno un premio, e un altro campo
a testo libero per i premi del tipo Circolo con maggior numero
di partecipanti.

Possono anche essere presenti delle menzioni speciali "Selezione del giurato",
ma solitamente ricadono nei premi di sezione e quindi sono altre pagine e
sono ancora da fare.

```sql
-- selezionare i nomi dei partecipanti che sono presenti
-- in almeno un prmeio del concorso, e se presenti in più premi 
-- spostarli in alto nella lista
select distinct 
       count(pcp_user_contacts.id) as n_prizes,
       pcp_user_contacts.country_id,
       pcp_user_contacts.last_name,
       pcp_user_contacts.first_name,
       pcp_countries.flag_code
  from pcp_user_contacts 
left join pcp_countries on (pcp_user_contacts.country_id = pcp_countries.id)
left join pcp_contest_awards on (pcp_user_contacts.user_id = pcp_contest_awards.winner_user_id)
WHERE pcp_contest_awards.contest_id = 'e8ac5674-c3d1-4afa-adaf-a7d5ed82d292'
  group by pcp_user_contacts.country_id,
  `pcp_user_contacts`.last_name,
  `pcp_user_contacts`.first_name
  order by 1 DESC,2,3,4
  ;

```

## Massimo ask

```text
for livewire laravel 12

select distinct 
       count(pcp_user_contacts.id) as n_prizes,
       pcp_user_contacts.country_id,
       pcp_user_contacts.last_name,
       pcp_user_contacts.first_name,
       pcp_countries.flag_code
  from pcp_user_contacts 
left join pcp_countries on (pcp_user_contacts.country_id = pcp_countries.id)
left join pcp_contest_awards on (pcp_user_contacts.user_id = pcp_contest_awards.winner_user_id)
WHERE pcp_contest_awards.contest_id = 'e8ac5674-c3d1-4afa-adaf-a7d5ed82d292'
  group by pcp_user_contacts.country_id,
  `pcp_user_contacts`.last_name,
  `pcp_user_contacts`.first_name
  order by 1 DESC,2,3,4
  ;
```

Che viene tradotta da gemini in questo:

### Gemini say

That's a complex SQL query involving several joins, a count, a `GROUP BY`, and a `WHERE` clause. You'll need to execute this using the **Laravel Query Builder** or the **`DB` facade** within your Livewire component and then pass the results to your Blade view for display.

Here's how you can implement this in a Livewire component:

### 1\. The Livewire Component Class

In your Livewire component's PHP class (e.g., `app/Livewire/ContestPrizes.php`), you will use the `DB` facade to execute the query and store the results in a public property.

```php
<?php

namespace App\Livewire;

use Livewire\Component;
use Illuminate\Support\Facades\DB;

class ContestPrizes extends Component
{
    // Public property to hold the query results
    public $prizes = [];
    
    // The specific contest ID you are querying for
    protected $contestId = 'e8ac5674-c3d1-4afa-adaf-a7d5ed82d292';

    public function mount()
    {
        // Execute the database query on component load
        $this->loadPrizes();
    }

    public function loadPrizes()
    {
        $this->prizes = DB::table('pcp_user_contacts')
            ->selectRaw('
                count(pcp_user_contacts.id) as n_prizes,
                pcp_user_contacts.country_id,
                pcp_user_contacts.last_name,
                pcp_user_contacts.first_name,
                pcp_countries.flag_code
            ')
            ->leftJoin('pcp_countries', 'pcp_user_contacts.country_id', '=', 'pcp_countries.id')
            ->leftJoin('pcp_contest_awards', 'pcp_user_contacts.user_id', '=', 'pcp_contest_awards.winner_user_id')
            ->where('pcp_contest_awards.contest_id', $this->contestId)
            ->groupBy(
                'pcp_user_contacts.country_id',
                'pcp_user_contacts.last_name',
                'pcp_user_contacts.first_name'
            )
            ->orderByDesc('n_prizes') // equivalent to order by 1 DESC
            ->orderBy('pcp_user_contacts.country_id') // equivalent to order by 2
            ->orderBy('pcp_user_contacts.last_name') // equivalent to order by 3
            ->orderBy('pcp_user_contacts.first_name') // equivalent to order by 4
            ->get();
    }

    public function render()
    {
        return view('livewire.contest-prizes');
    }
}
```

* **`DB::table()` and `selectRaw()`:** Since you are using aggregate functions (`COUNT`) and need to select distinct columns, using `DB::table()` with `selectRaw()` is the most straightforward way to translate your complex SQL into the Query Builder.
* **`mount()`:** The `mount()` lifecycle hook is used to load the data when the component is initially rendered.
* **`$prizes`:** The results are stored in the public `$prizes` property, making them available to the Blade view.

### 2\. The Livewire Blade View

In your component's Blade file (e.g., `resources/views/livewire/contest-prizes.blade.php`), you can loop through the `$prizes` collection and display the results in an HTML table.

```blade
<div>
    <h2>Contest Prize Winners (Contest ID: {{ $contestId }})</h2>

    @if ($prizes->count() > 0)
        <table class="table-auto w-full">
            <thead>
                <tr>
                    <th>Prizes Won</th>
                    <th>Flag</th>
                    <th>Last Name</th>
                    <th>First Name</th>
                    <th>Country ID</th>
                </tr>
            </thead>
            <tbody>
                @foreach ($prizes as $winner)
                    <tr>
                        <td>{{ $winner->n_prizes }}</td>
                        <td>{{ $winner->flag_code }}</td>
                        <td>{{ $winner->last_name }}</td>
                        <td>{{ $winner->first_name }}</td>
                        <td>{{ $winner->country_id }}</td>
                    </tr>
                @endforeach
            </tbody>
        </table>
    @else
        <p>No winners found for this contest.</p>
    @endif
</div>
```

This structure is a common pattern for displaying complex database results in Livewire components.


This video gives a quick tip on viewing the actual SQL queries executed by the Laravel `DB` facade, which can be very helpful when debugging complex queries like yours. [Quickly View SQL Queries in Laravel with DB::listen (No Debugbar)](https://www.youtube.com/watch?v=kgV1tVYoQfs)

<http://googleusercontent.com/youtube_content/0>

----

Tutto bello ma c'è un particolare che si fa notare: tutti i premi pesano uno,
e nel caso ci sia qualcuno che in 7 sezioni prende la menzione d'onore
primeggia rispetto a qualcuno che è arrivato secondo o primo in 4 sezioni.
Sta quindi alla giuria pesare la qualità di quei voti, a meno che:

TODO assegnare in elenco premi contest_award un "peso" o valore del premio
fatto 1 la menzione speciale, un premio dovrebbe pesare 3, un terzo posto
dovrebbe pesare 10, un secondo 20, un primo 40. Così la somma sarebbe
più rappresentativa della qualità dei premi ottenuti.

Fatto, manca solo un collaudo di funzionalità, però pint ha messo
le mani anche su una mezza dozzina di elementi.

A domani.
